% !TEX TS-program = xelatex
% !TEX encoding = UTF-8 Unicode
\documentclass[gap.tex]{subfiles}
\begin{document}
\label{sec:bonus-distance-use}

\begin{quote}
    For all distance point calculations, including the difficulty calculations
    in hang-gliding (see ~\ref{sec:difficulty-calculation}), these new stopped
    distance values are being used to determine the pilotsâ€™ best distance
    values.  Time and leading point calculations remain the same: they are not
    affected by the altitude bonus or stopped distance values. 
\end{quote}

This appendix, expands on this brief but broad statement (see
~\ref{sec:distance-stopped-tasks}) showing how and when distance or bonus
distances are used in calculating validities and weights and when allocation
points.

\begin{lstlisting}[style=base, caption={Launch Validity doesn't depend on distance inputs.}]
double launch_validity =
    CalcLaunchValidity
        ( sp.No_of_pilots_flying
        , sp.No_of_pilots_present
        , sfg
        );
\end{lstlisting}

\begin{lstlisting}[style=base, caption={Time Validity depends on \textcolor{red}{bonus} distance input.}]
double @>time_validity@> =
    CalcTimeValidity
        ( time_validity_time
        , (double)sfg.Nom_time
        , sp.@>Best_dist@>
        , sfg.Nom_dist
        );
\end{lstlisting}

\begin{lstlisting}[style=base, caption={Distance Validity depends on \textcolor{blue}{real} distance inputs.}]
double <@distance_validity<@ =
    CalcDistanceValidity
        ( sp.<@Sum_real_dist_over_min<@
        , sp.No_of_pilots_flying
        , (double)sfg.Nom_goal
        , sfg.Nom_dist
        , sfg.Min_dist
        , sp.<@Best_real_dist<@
        );
\end{lstlisting}

\begin{lstlisting}[style=base, caption={Stop Validity depends on \textcolor{blue}{real} distance inputs.}]
sp.<@Sum_flown_distances<@ += p.<@_real_distance<@;
<@distances<@[distance_counter++] = p.<@_real_distance<@;

double <@avg_distance<@ = sp.<@Sum_flown_distances<@ / sp.No_of_pilots_flying;
double <@sumOfDerivation<@ = 0;
for (int i = 0; i < distances.Length; i++)
{
  <@sumOfDerivation<@ += <@distances<@[i] * <@distances<@[i];
}
double <@sumOfDerivationAverage<@ = <@sumOfDerivation<@ / sp.No_of_pilots_flying;
double <@stdev_distance<@ = Math.Sqrt(<@sumOfDerivationAverage<@ - (<@avg_distance<@ * <@avg_distance<@));

double <@stop_validity<@ =
    CalcStopValidity
        ( sfg
        , sp.Last_start_time
        , task_state.TaskStopTime
        , sp.<@Best_real_dist<@
        , sp.Launch_to_ess_distance
        , <@avg_distance<@
        , <@stdev_distance<@
        , sp.No_of_pilots_landed_before_stop
        , sp.No_of_pilots_flying
        , sp.No_of_pilots_reaching_ES
        , task_state.IsStopped
        );
\end{lstlisting}

\begin{lstlisting}[style=base, caption={Day Quality depends on \textcolor{red}{bonus} distance.}]
double @>day_quality@> =
    CalcDayQuality
        ( @>time_validity@>
        , launch_validity
        , <@distance_validity<@
        , <@stop_validity<@
        );
\end{lstlisting}

\end{document}
